<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NEXUS | Network Intelligence</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg:        #050505;
      --cyan:      #00f3ff;
      --pink:      #ff00ff;
      --green:     #00ff41;
      --amber:     #ffae00;
      --red:       #ff4444;
      --text:      #cceeff;
      --dim:       rgba(204,238,255,0.38);
      --border:    rgba(0,243,255,0.13);
      --surface:   rgba(0,10,20,0.5);
      --f-hud:     'Orbitron', sans-serif;
      --f-mono:    'Share Tech Mono', monospace;
    }
    *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
    body { background:var(--bg); color:var(--text); font-family:var(--f-mono); min-height:100vh; overflow-x:hidden; }

    /* ── BOOT ───────────────────────────────────────────────────────────── */
    #boot {
      position:fixed; inset:0; z-index:200;
      display:flex; align-items:center; justify-content:center;
      background:#010810;
      transition:opacity .7s ease;
    }
    #boot.out { opacity:0; pointer-events:none; }

    #term {
      position:relative;
      width:min(580px,92vw);
      background:rgba(0,6,14,.97);
      border:1px solid var(--cyan);
      padding:26px 24px 22px;
      font-size:clamp(.68rem,1.7vw,.83rem);
      box-shadow:0 0 50px rgba(0,243,255,.12), inset 0 0 30px rgba(0,0,0,.6);
    }
    #term::before {
      content:'NEXUS_BOOT_v8.0';
      position:absolute; top:-10px; left:16px;
      font-family:var(--f-hud); font-size:.58rem; letter-spacing:3px;
      color:var(--cyan); background:#010810; padding:0 8px;
    }
    #term::after {
      content:'';
      position:absolute; bottom:-1px; right:-1px;
      width:12px; height:12px;
      border-bottom:2px solid var(--cyan); border-right:2px solid var(--cyan);
    }
    #boot-lines { min-height:230px; overflow:hidden; }
    .bl { line-height:1.9; white-space:pre; animation:blin .22s ease both; }
    @keyframes blin { from{opacity:0;transform:translateX(-6px)} to{opacity:1;transform:none} }
    .bt  { font-family:var(--f-hud); font-size:clamp(.95rem,2.8vw,1.25rem); color:var(--cyan); letter-spacing:6px; text-shadow:0 0 30px var(--cyan); }
    .bs  { color:var(--pink); font-size:.7rem; letter-spacing:3px; }
    .bd  { color:rgba(0,243,255,.32); }
    .bok { color:var(--green); }
    .bw  { color:var(--amber); }
    .br  { color:var(--cyan); }
    .ba  { color:var(--pink); }
    #cur { display:inline-block; width:7px; height:13px; background:var(--cyan); margin-left:2px; vertical-align:middle; animation:cur .7s step-end infinite; }
    @keyframes cur { 0%,100%{opacity:1} 50%{opacity:0} }
    .bbar { margin-top:14px; height:2px; background:rgba(0,243,255,.1); overflow:hidden; }
    #bprog { height:100%; width:0%; background:linear-gradient(90deg,var(--cyan),var(--pink)); box-shadow:0 0 8px var(--cyan); transition:width .3s ease; }

    /* ── FIXED OVERLAYS ─────────────────────────────────────────────────── */
    .scanlines {
      position:fixed; inset:0; z-index:1; pointer-events:none;
      background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.07) 2px,rgba(0,0,0,.07) 4px);
    }
    .vignette {
      position:fixed; inset:0; z-index:1; pointer-events:none;
      background:radial-gradient(ellipse at center,transparent 50%,rgba(0,0,0,.7) 100%);
    }
    #bg { position:fixed; inset:0; z-index:0; pointer-events:none; }

    /* ── MAIN APP ───────────────────────────────────────────────────────── */
    #app {
      position:relative; z-index:10;
      display:none; flex-direction:column; align-items:center;
      min-height:100vh; padding:14px 12px 30px;
      opacity:0; transition:opacity .5s ease;
    }
    #app.on { opacity:1; }
    .shell { width:100%; max-width:1100px; display:flex; flex-direction:column; gap:11px; }

    /* ── HEADER ─────────────────────────────────────────────────────────── */
    .hdr {
      display:flex; justify-content:space-between; align-items:flex-end;
      padding:15px 20px; gap:12px; flex-wrap:wrap;
      background:var(--surface); border:1px solid var(--border); border-top:2px solid var(--cyan);
    }
    .brand {
      font-family:var(--f-hud); font-size:clamp(1.5rem,5vw,2.4rem); font-weight:900; letter-spacing:.15em;
      background:linear-gradient(130deg,var(--cyan),#fff 55%,var(--cyan));
      -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
      animation:glitch 10s infinite;
    }
    @keyframes glitch {
      0%,84%,100%{filter:none;transform:none}
      86%{filter:drop-shadow(-2px 0 var(--pink)) drop-shadow(2px 0 var(--cyan));transform:translateX(-1px)}
      88%{filter:none;transform:none}
      90%{filter:drop-shadow(2px 0 var(--pink));transform:translateX(2px)}
      92%{filter:none;transform:none}
    }
    .brand-sub { font-size:.62rem; color:var(--pink); letter-spacing:3px; margin-top:4px; }
    .hdr-right { text-align:right; display:flex; flex-direction:column; gap:4px; align-items:flex-end; }
    .h-clock { font-family:var(--f-hud); font-size:1rem; color:var(--cyan); }
    .h-tag { font-size:.6rem; letter-spacing:2px; display:flex; align-items:center; gap:5px; }
    .dot { width:6px; height:6px; border-radius:50%; background:var(--green); box-shadow:0 0 6px var(--green); animation:pulse 1.6s ease-in-out infinite; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.3} }
    #cip { color:var(--amber); }

    /* ── SEARCH ─────────────────────────────────────────────────────────── */
    .search {
      background:var(--surface); border:1px solid var(--border); padding:16px 18px;
    }
    .slabel { font-size:.6rem; letter-spacing:3px; color:var(--dim); margin-bottom:9px; }
    .srow { display:flex; gap:9px; align-items:stretch; }
    .iwrap { position:relative; flex:1; }
    .ipfx { position:absolute; left:13px; top:50%; transform:translateY(-50%); color:var(--cyan); font-size:.88rem; pointer-events:none; }
    #qi {
      width:100%; background:rgba(0,0,0,.55); border:1px solid rgba(0,243,255,.4);
      color:var(--cyan); font-family:var(--f-mono); font-size:1rem;
      padding:12px 13px 12px 30px; outline:none; transition:.2s;
    }
    @media(max-width:480px){ #qi{font-size:16px} }
    #qi::placeholder { color:rgba(0,243,255,.27); }
    #qi:focus { background:rgba(0,243,255,.04); box-shadow:0 0 0 1px var(--cyan),0 0 16px rgba(0,243,255,.1); }
    #qbtn {
      padding:12px 24px; background:rgba(255,0,255,.06); border:1px solid var(--pink);
      color:var(--pink); font-family:var(--f-hud); font-size:.76rem; letter-spacing:2px;
      cursor:pointer; transition:.25s; white-space:nowrap; min-height:44px;
    }
    #qbtn:hover:not(:disabled){ background:var(--pink); color:#000; box-shadow:0 0 22px rgba(255,0,255,.45); }
    #qbtn:disabled { opacity:.3; cursor:not-allowed; }
    .shint { margin-top:7px; font-size:.6rem; color:var(--dim); }
    .shint kbd { background:rgba(0,243,255,.08); border:1px solid var(--border); padding:1px 5px; color:var(--cyan); font-size:.6rem; }
    .sbar { height:2px; background:rgba(0,243,255,.08); overflow:hidden; margin-top:9px; display:none; }
    .sbar.on { display:block; }
    .sfill { height:100%; width:35%; background:linear-gradient(90deg,transparent,var(--cyan),var(--pink),transparent); animation:ss 1.3s ease-in-out infinite; }
    @keyframes ss { 0%{transform:translateX(-200%)} 100%{transform:translateX(400%)} }

    /* ── HISTORY ────────────────────────────────────────────────────────── */
    .hbar {
      display:flex; align-items:center; gap:8px; flex-wrap:wrap;
      padding:8px 13px; background:rgba(0,5,12,.6); border:1px solid var(--border); min-height:40px;
    }
    .hlbl { font-size:.6rem; letter-spacing:2px; color:var(--dim); flex-shrink:0; }
    .hchip {
      padding:4px 11px; background:transparent; border:1px solid var(--border);
      color:var(--cyan); font-family:var(--f-mono); font-size:.7rem;
      cursor:pointer; transition:.2s; min-height:30px;
    }
    .hchip:hover { border-color:var(--cyan); background:rgba(0,243,255,.08); }
    .hclr {
      padding:3px 10px; background:transparent; border:1px solid rgba(255,68,68,.28);
      color:rgba(255,68,68,.6); font-family:var(--f-mono); font-size:.6rem;
      cursor:pointer; transition:.2s; margin-left:auto; min-height:28px;
    }
    .hclr:hover { border-color:var(--red); color:var(--red); }

    /* ── RESULTS GRID ───────────────────────────────────────────────────── */
    .grid {
      display:grid;
      grid-template-columns:1fr 1fr;
      grid-template-areas:"core geo" "ports ports" "dns http";
      gap:11px;
    }
    @media(max-width:899px){
      .grid { grid-template-columns:1fr; grid-template-areas:"core""geo""ports""dns""http"; }
    }
    .a-core  { grid-area:core; }
    .a-geo   { grid-area:geo; }
    .a-ports { grid-area:ports; }
    .a-dns   { grid-area:dns; }
    .a-http  { grid-area:http; }

    /* ── PANEL ──────────────────────────────────────────────────────────── */
    .panel {
      background:rgba(0,10,20,.45); border:1px solid var(--border);
      display:flex; flex-direction:column; position:relative; transition:border-color .3s;
    }
    .panel:hover { border-color:rgba(0,243,255,.28); }
    .panel::before {
      content:''; position:absolute; top:-1px; left:-1px;
      width:10px; height:10px; border-top:1px solid var(--cyan); border-left:1px solid var(--cyan);
    }
    .panel::after {
      content:''; position:absolute; bottom:-1px; right:-1px;
      width:10px; height:10px; border-bottom:1px solid var(--cyan); border-right:1px solid var(--cyan);
    }
    .ph {
      display:flex; justify-content:space-between; align-items:center;
      padding:9px 15px; border-bottom:1px solid var(--border); background:rgba(0,243,255,.02);
      flex-shrink:0;
    }
    .pt { font-family:var(--f-hud); font-size:.66rem; letter-spacing:2px; color:var(--cyan); }
    .pbadge { font-size:.56rem; padding:2px 7px; border:1px solid var(--amber); color:var(--amber); letter-spacing:1px; display:none; }
    .pmeta  { font-size:.6rem; color:var(--dim); letter-spacing:1px; }
    .pmeta.open { color:var(--green); }
    .scanning .ph { animation:spulse 1.2s ease-in-out infinite; }
    @keyframes spulse { 0%,100%{border-bottom-color:var(--border)} 50%{border-bottom-color:rgba(0,243,255,.5)} }
    .pb { padding:11px 15px; flex:1; display:flex; flex-direction:column; }
    .idle { display:flex; flex-direction:column; align-items:center; justify-content:center; gap:5px; flex:1; min-height:75px; color:var(--dim); }
    .idle-icon { font-family:var(--f-hud); font-size:.68rem; letter-spacing:3px; }
    .idle-txt  { font-size:.65rem; letter-spacing:1px; }

    /* ── DATA ROWS ──────────────────────────────────────────────────────── */
    .dr {
      display:grid; grid-template-columns:125px 1fr; align-items:baseline; gap:10px;
      padding:5px 0; border-bottom:1px solid rgba(255,255,255,.04);
      opacity:0; transform:translateX(-7px); transition:opacity .38s ease,transform .38s ease;
    }
    .dr:last-child { border-bottom:none; }
    .dr.on { opacity:1; transform:none; }
    .dl { font-size:.63rem; letter-spacing:.5px; color:var(--dim); text-transform:uppercase; white-space:nowrap; }
    .dv { font-size:.78rem; color:var(--cyan); word-break:break-all; }
    .dv.g { color:var(--green); }
    .dv.a { color:var(--amber); }
    .dv.r { color:var(--red); }
    .dv.d { color:var(--dim); }
    .map  { cursor:pointer; border-bottom:1px dashed rgba(0,243,255,.35); transition:color .2s; }
    .map:hover { color:#fff; }
    .txt-r { cursor:help; border-bottom:1px dashed rgba(0,243,255,.3); transition:color .2s; }
    .txt-r:hover { color:#fff; }
    @media(max-width:500px){ .dr{grid-template-columns:1fr;gap:2px} }

    /* ── PORT BADGES ────────────────────────────────────────────────────── */
    .pgrid { display:flex; flex-wrap:wrap; gap:7px; padding:3px 0; }
    .pbadge-port {
      display:flex; flex-direction:column; align-items:center;
      padding:5px 10px; min-width:52px; gap:2px;
      background:rgba(0,255,65,.07); border:1px solid rgba(0,255,65,.38);
      transition:background .2s,box-shadow .2s;
    }
    .pbadge-port:hover { background:rgba(0,255,65,.15); box-shadow:0 0 12px rgba(0,255,65,.25); }
    .pnum { font-family:var(--f-hud); font-size:.8rem; font-weight:700; color:var(--green); }
    .psvc { font-size:.57rem; color:rgba(0,255,65,.65); text-transform:uppercase; letter-spacing:.5px; }
    .closed-list { font-size:.65rem; color:var(--dim); line-height:1.8; padding-top:5px; word-break:break-all; }

    /* ── SECURITY BADGES ────────────────────────────────────────────────── */
    .secs { display:flex; flex-wrap:wrap; gap:5px; }
    .sbadge { padding:2px 7px; font-size:.6rem; border:1px solid; letter-spacing:.5px; white-space:nowrap; }
    .sok  { border-color:var(--green); color:var(--green); background:rgba(0,255,65,.05); }
    .snok { border-color:var(--red);   color:var(--red);   background:rgba(255,68,68,.05); }

    /* ── ACTION BAR ─────────────────────────────────────────────────────── */
    .abar { display:flex; justify-content:flex-end; gap:9px; flex-wrap:wrap; }
    .abtn {
      padding:9px 20px; background:rgba(0,243,255,.04); border:1px solid rgba(0,243,255,.38);
      color:var(--cyan); font-family:var(--f-hud); font-size:.66rem; letter-spacing:2px;
      cursor:pointer; transition:.2s; min-height:38px;
    }
    .abtn:hover:not(:disabled){ background:rgba(0,243,255,.12); box-shadow:0 0 14px rgba(0,243,255,.18); }
    .abtn:disabled { opacity:.2; cursor:not-allowed; pointer-events:none; }

    /* ── CONSOLE ────────────────────────────────────────────────────────── */
    .cons { background:#000; border:1px solid var(--border); }
    .cons-h {
      display:flex; justify-content:space-between; align-items:center;
      padding:7px 13px; border-bottom:1px solid var(--border); background:rgba(0,255,65,.02);
    }
    .cons-title { font-family:var(--f-hud); font-size:.6rem; letter-spacing:2px; color:var(--green); }
    #cev { font-size:.58rem; color:var(--dim); }
    .cons-b { height:120px; overflow-y:auto; padding:7px 13px; }
    .cl { font-size:.7rem; color:var(--green); padding:1px 0; border-bottom:1px solid rgba(0,255,65,.05); white-space:pre-wrap; word-break:break-all; }
    .cl.e { color:var(--red); }
    .cl.w { color:var(--amber); }
    .cl.i { color:var(--cyan); }

    ::-webkit-scrollbar { width:4px; height:4px; }
    ::-webkit-scrollbar-track { background:transparent; }
    ::-webkit-scrollbar-thumb { background:rgba(0,243,255,.22); border-radius:4px; }

    @media(max-width:480px){
      #app { padding:8px 8px 20px; }
      .hdr { padding:11px 13px; }
      .search { padding:13px; }
      #qbtn { padding:12px 14px; }
      .pb { padding:9px 11px; }
    }
  </style>
</head>
<body>
  <div class="scanlines"></div>
  <div class="vignette"></div>
  <canvas id="bg"></canvas>

  <!-- BOOT SCREEN -->
  <div id="boot">
    <div id="term">
      <div id="boot-lines"></div>
      <span id="cur"></span>
      <div class="bbar"><div id="bprog"></div></div>
    </div>
  </div>

  <!-- MAIN APP -->
  <div id="app">
    <div class="shell">

      <!-- HEADER -->
      <header class="hdr">
        <div>
          <div class="brand">NEXUS</div>
          <div class="brand-sub">// NETWORK_INTEL_V8 &nbsp;·&nbsp; OSINT SUITE</div>
        </div>
        <div class="hdr-right">
          <div class="h-clock" id="clock">00:00:00</div>
          <div class="h-tag"><span class="dot"></span><span style="color:var(--green);letter-spacing:2px">SYSTEM ACTIVE</span></div>
          <div class="h-tag" id="cip">CLIENT ▸ DETECTING...</div>
        </div>
      </header>

      <!-- SEARCH -->
      <section class="search">
        <p class="slabel">▸ TARGET INPUT</p>
        <div class="srow">
          <div class="iwrap">
            <span class="ipfx">▶</span>
            <input id="qi" type="text" placeholder="IP · domain · URL  (e.g. 8.8.8.8  or  github.com)" autocomplete="off" spellcheck="false" />
          </div>
          <button id="qbtn">EXECUTE</button>
        </div>
        <div class="sbar" id="sbar"><div class="sfill"></div></div>
        <p class="shint">Press <kbd>Enter</kbd> or click EXECUTE to begin scan</p>
      </section>

      <!-- HISTORY -->
      <div class="hbar" id="hbar">
        <span class="hlbl">RECENT ▸</span>
        <span style="color:var(--dim);font-size:.7rem">No history yet.</span>
      </div>

      <!-- RESULTS GRID -->
      <div class="grid" id="rgrid">

        <div class="panel a-core">
          <div class="ph"><span class="pt">◉ &nbsp;CORE_METRICS</span><span class="pbadge" id="typebadge"></span></div>
          <div class="pb" id="rCore">
            <div class="idle"><span class="idle-icon">[ — ]</span><span class="idle-txt">AWAITING SCAN</span></div>
          </div>
        </div>

        <div class="panel a-geo">
          <div class="ph"><span class="pt">⊕ &nbsp;GEO_LOCATION</span></div>
          <div class="pb" id="rGeo">
            <div class="idle"><span class="idle-icon">[ — ]</span><span class="idle-txt">AWAITING SCAN</span></div>
          </div>
        </div>

        <div class="panel a-ports">
          <div class="ph"><span class="pt">▣ &nbsp;PORT_SCAN</span><span class="pmeta" id="portmeta"></span></div>
          <div class="pb" id="rPorts">
            <div class="idle"><span class="idle-icon">[ — ]</span><span class="idle-txt">AWAITING SCAN</span></div>
          </div>
        </div>

        <div class="panel a-dns">
          <div class="ph"><span class="pt">◈ &nbsp;DNS_RECORDS</span></div>
          <div class="pb" id="rDns">
            <div class="idle"><span class="idle-icon">[ — ]</span><span class="idle-txt">AWAITING SCAN</span></div>
          </div>
        </div>

        <div class="panel a-http">
          <div class="ph"><span class="pt">⊞ &nbsp;HTTP_INTEL</span></div>
          <div class="pb" id="rHttp">
            <div class="idle"><span class="idle-icon">[ — ]</span><span class="idle-txt">AWAITING SCAN</span></div>
          </div>
        </div>

      </div>

      <!-- ACTION BAR -->
      <div class="abar">
        <button class="abtn" id="btnCopy" disabled>⊡ &nbsp;COPY JSON</button>
        <button class="abtn" id="btnExport" disabled>⤓ &nbsp;EXPORT .JSON</button>
      </div>

      <!-- CONSOLE -->
      <div class="cons">
        <div class="cons-h">
          <span class="cons-title">SYSTEM_CONSOLE</span>
          <span id="cev">0 events</span>
        </div>
        <div class="cons-b" id="cb">
          <div class="cl i">[SYSTEM] Nexus v8 loaded. All modules active.</div>
        </div>
      </div>

    </div>
  </div>

  <script>
    // ── BOOT ──────────────────────────────────────────────────────────────
    const SEQ = [
      {t:120,  txt:'NEXUS',                                       c:'bt'},
      {t:320,  txt:'// NETWORK INTELLIGENCE SYSTEM',             c:'bs'},
      {t:560,  txt:'',                                            c:''},
      {t:710,  txt:'> INITIALIZING CORE MODULES...',             c:'bd'},
      {t:950,  txt:'[OK] Network socket layer ready',            c:'bok'},
      {t:1130, txt:'[OK] DNS resolver chains verified',          c:'bok'},
      {t:1300, txt:'[OK] Port scanner: 16 targets armed',        c:'bok'},
      {t:1460, txt:'[  ] Connecting to geo-intelligence...',     c:'bw'},
      {t:1730, txt:'[OK] GEO API endpoint confirmed',            c:'bok'},
      {t:1890, txt:'[OK] HTTP fingerprint engine active',        c:'bok'},
      {t:2040, txt:'[OK] Rate limiter active (15 req/min)',      c:'bok'},
      {t:2200, txt:'',                                            c:''},
      {t:2360, txt:'> ALL SYSTEMS NOMINAL',                      c:'br'},
      {t:2530, txt:'> AWAITING TARGET INPUT',                    c:'ba'},
    ];
    const OK_COUNT = SEQ.filter(s => s.c === 'bok').length;
    let okSeen = 0;

    (function boot() {
      const el  = document.getElementById('boot-lines');
      const bar = document.getElementById('bprog');
      SEQ.forEach(({t, txt, c}) => {
        setTimeout(() => {
          if (!txt && !c) { el.appendChild(document.createElement('br')); return; }
          const d = document.createElement('div');
          d.className = `bl ${c}`;
          d.textContent = txt;
          el.appendChild(d);
          if (c === 'bok') { okSeen++; bar.style.width = `${Math.round(okSeen/OK_COUNT*100)}%`; }
        }, t);
      });
      setTimeout(() => {
        const a = document.getElementById('app');
        a.style.display = 'flex';
        requestAnimationFrame(() => requestAnimationFrame(() => a.classList.add('on')));
      }, 2900);
      setTimeout(() => document.getElementById('boot').classList.add('out'), 3100);
      setTimeout(() => document.getElementById('boot').style.display = 'none', 3800);
    })();

    // ── CANVAS ────────────────────────────────────────────────────────────
    (function canvas() {
      const cv = document.getElementById('bg');
      const cx = cv.getContext('2d');
      let W, H, pts = [];
      const resize = () => { W = cv.width = innerWidth; H = cv.height = innerHeight; };
      window.addEventListener('resize', resize); resize();
      class P {
        constructor(){ this.x=Math.random()*W; this.y=Math.random()*H; this.vx=(Math.random()-.5)*.4; this.vy=(Math.random()-.5)*.4; }
        step(){ this.x+=this.vx; this.y+=this.vy; if(this.x<0||this.x>W)this.vx*=-1; if(this.y<0||this.y>H)this.vy*=-1; }
        draw(){ cx.fillStyle='rgba(0,200,255,.55)'; cx.beginPath(); cx.arc(this.x,this.y,1,0,Math.PI*2); cx.fill(); }
      }
      for(let i=0;i<55;i++) pts.push(new P());
      (function loop(){
        cx.fillStyle='rgba(5,5,5,.12)'; cx.fillRect(0,0,W,H);
        for(let i=0;i<pts.length;i++){
          pts[i].step(); pts[i].draw();
          for(let j=i+1;j<pts.length;j++){
            const dx=pts[i].x-pts[j].x, dy=pts[i].y-pts[j].y, d=Math.sqrt(dx*dx+dy*dy);
            if(d<115){ cx.strokeStyle=`rgba(0,200,255,${.1*(1-d/115)})`; cx.lineWidth=.5; cx.beginPath(); cx.moveTo(pts[i].x,pts[i].y); cx.lineTo(pts[j].x,pts[j].y); cx.stroke(); }
          }
        }
        requestAnimationFrame(loop);
      })();
    })();

    // ── CLOCK ─────────────────────────────────────────────────────────────
    setInterval(() => document.getElementById('clock').textContent = new Date().toLocaleTimeString(), 1000);

    // ── LOG ───────────────────────────────────────────────────────────────
    let evCount = 0;
    function log(msg, t='') {
      evCount++;
      document.getElementById('cev').textContent = `${evCount} event${evCount!==1?'s':''}`;
      const b = document.getElementById('cb');
      const d = document.createElement('div');
      d.className = `cl${t?' '+t:''}`;
      d.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      b.appendChild(d); b.scrollTop = b.scrollHeight;
    }

    // ── CLIENT IP ─────────────────────────────────────────────────────────
    fetch('/api/whoami').then(r=>r.json()).then(d=>{
      document.getElementById('cip').textContent = `CLIENT ▸ ${d.ip}`;
      log(`Connected from: ${d.ip}`, 'i');
    }).catch(()=>{ document.getElementById('cip').textContent='CLIENT ▸ UNKNOWN'; });

    // ── HISTORY ───────────────────────────────────────────────────────────
    const HK = 'nx8h', HM = 8;
    const loadH  = () => { try{ return JSON.parse(localStorage.getItem(HK))||[]; }catch{ return []; } };
    const saveH  = e  => { let h=loadH().filter(x=>x.i!==e.i); h.unshift(e); localStorage.setItem(HK,JSON.stringify(h.slice(0,HM))); };
    function renderH() {
      const bar = document.getElementById('hbar'), h = loadH();
      bar.innerHTML = '<span class="hlbl">RECENT ▸</span>';
      if(!h.length){ bar.innerHTML+='<span style="color:var(--dim);font-size:.7rem">No history yet.</span>'; return; }
      h.forEach(e=>{
        const c=document.createElement('button'); c.className='hchip'; c.title=`${e.ip||''}${e.cc?' · '+e.cc:''}`; c.textContent=e.i;
        c.addEventListener('click',()=>{ document.getElementById('qi').value=e.i; run(); }); bar.appendChild(c);
      });
      const x=document.createElement('button'); x.className='hclr'; x.textContent='CLEAR';
      x.addEventListener('click',()=>{ localStorage.removeItem(HK); renderH(); log('History cleared.'); }); bar.appendChild(x);
    }
    renderH();

    // ── ADD ROW HELPER ────────────────────────────────────────────────────
    function row(id, lbl, val, delay=0, cls='') {
      const d=document.createElement('div'); d.className='dr';
      d.innerHTML=`<span class="dl">${lbl}</span><span class="dv ${cls}">${val}</span>`;
      document.getElementById(id).appendChild(d);
      setTimeout(()=>d.classList.add('on'), delay);
      return d;
    }
    function scls(code){ return code<300?'g':code<400?'a':'r'; }

    // ── RENDER ────────────────────────────────────────────────────────────
    let last = null;
    function render(data) {
      let d=0; const S=72;

      // badge
      const b=document.getElementById('typebadge');
      b.textContent=data.inputType.toUpperCase(); b.style.display='inline-block';

      // CORE
      row('rCore','TYPE',      data.inputType.toUpperCase(),                                          d+=S);
      row('rCore','HOSTNAME',  data.hostname||'—',                                                    d+=S);
      row('rCore','IP',        data.ipAddresses?data.ipAddresses.join(', '):(data.ip||'—'),           d+=S);
      (data.reverseHostnames||[]).forEach(h=>row('rCore','REVERSE DNS',h, d+=S-15));
      if(data.protocol) row('rCore','PROTOCOL', data.protocol.replace(':','').toUpperCase(),          d+=S);
      row('rCore','SCANNED',   new Date(data.timestamp).toLocaleString(),                             d+=S,'a');

      // GEO
      if(data.geo){
        const g=data.geo;
        row('rGeo','COUNTRY',  `${g.country} (${g.countryCode})`,  d+=S);
        row('rGeo','CITY',     g.city||'—',                         d+=S);
        row('rGeo','ISP',      g.isp||'—',                          d+=S);
        if(g.org)      row('rGeo','ORG',      g.org,      d+=S);
        if(g.as)       row('rGeo','ASN',      g.as,       d+=S);
        if(g.timezone) row('rGeo','TIMEZONE', g.timezone, d+=S);
        if(g.lat!=null&&g.lon!=null){
          const coord=`${g.lat.toFixed(4)}, ${g.lon.toFixed(4)}`;
          const r=row('rGeo','COORDINATES',`<span class="map">${coord}</span>`,d+=S);
          r.querySelector('.map').addEventListener('click',()=>window.open(`https://www.google.com/maps?q=${g.lat},${g.lon}`,'_blank'));
        }
      } else {
        row('rGeo','LOCATION','Private / Local IP', d+=S,'a');
      }

      // PORTS
      const opens = data.openPorts||[];
      const total = data.portsScanned ? data.portsScanned.length : 16;
      const meta  = document.getElementById('portmeta');
      meta.textContent = `${opens.length} OPEN · ${total} SCANNED`;
      meta.className   = `pmeta${opens.length?'  open':''}`;

      if(opens.length){
        const w=document.createElement('div'); w.className='dr';
        w.innerHTML=`<span class="dl" style="padding-top:3px">OPEN PORTS</span><div class="pgrid">${
          opens.map(p=>`<div class="pbadge-port"><span class="pnum">${p.port}</span><span class="psvc">${p.service}</span></div>`).join('')
        }</div>`;
        document.getElementById('rPorts').appendChild(w);
        setTimeout(()=>w.classList.add('on'), d+=S);
        opens.forEach(p=>log(`Open: ${p.port} (${p.service})`,'i'));
      } else {
        row('rPorts','STATUS','No open ports detected', d+=S,'a');
      }
      if(data.portsScanned){
        const on=opens.map(p=>p.port);
        const cl=data.portsScanned.filter(p=>!on.includes(p));
        if(cl.length){
          const cr=document.createElement('div'); cr.className='dr';
          cr.innerHTML=`<span class="dl">FILTERED</span><span class="dv d closed-list">${cl.join(' · ')}</span>`;
          document.getElementById('rPorts').appendChild(cr);
          setTimeout(()=>cr.classList.add('on'), d+=S);
        }
      }

      // DNS
      let dnsAny=false;
      if(data.dns){
        (data.dns.mx||[]).forEach(mx=>{ dnsAny=true; row('rDns','MX',`${mx.exchange} <span style="opacity:.44">(pri ${mx.priority})</span>`,d+=S); });
        (data.dns.ns||[]).forEach(ns=>{ dnsAny=true; row('rDns','NS',ns,d+=S-15); });
        (data.dns.txt||[]).forEach((rec,i)=>{
          dnsAny=true;
          const short=rec.length>66?rec.slice(0,63)+'…':rec;
          row('rDns',`TXT[${i}]`,`<span class="txt-r" title="${rec.replace(/"/g,'&quot;')}">${short}</span>`,d+=S-20);
          log(`TXT[${i}]: ${rec.slice(0,55)}${rec.length>55?'…':''}`);
        });
      }
      if(!dnsAny) row('rDns','STATUS','No DNS records found', d+=S,'a');

      // HTTP
      if(data.http&&!data.http.error){
        const h=data.http;
        if(h.status)      row('rHttp','STATUS',      `${h.status} ${h.statusText||''}`, d+=S, scls(h.status));
        if(h.server)      row('rHttp','SERVER',      h.server,                           d+=S,'g');
        if(h.poweredBy)   row('rHttp','POWERED BY',  h.poweredBy,                        d+=S,'g');
        if(h.contentType) row('rHttp','CONTENT TYPE',h.contentType.split(';')[0],        d+=S);
        const sr=document.createElement('div'); sr.className='dr';
        sr.innerHTML=`<span class="dl">SECURITY</span><div class="secs">
          ${h.hsts?'<span class="sbadge sok">HSTS ✓</span>':'<span class="sbadge snok">HSTS ✗</span>'}
          ${h.xFrameOptions?`<span class="sbadge sok">X-FRAME: ${h.xFrameOptions}</span>`:'<span class="sbadge snok">X-FRAME MISSING</span>'}
        </div>`;
        document.getElementById('rHttp').appendChild(sr);
        setTimeout(()=>sr.classList.add('on'), d+=S);
      } else if(data.http&&data.http.error){
        row('rHttp','STATUS','Host unreachable via HTTP', d+=S,'a');
      } else {
        row('rHttp','NOTE','HTTP scan skipped for raw IP input', d+=S,'d');
      }
    }

    // ── TRACE ─────────────────────────────────────────────────────────────
    async function run() {
      const input=document.getElementById('qi').value.trim();
      if(!input) return;
      const btn=document.getElementById('qbtn'), bar=document.getElementById('sbar'), grid=document.getElementById('rgrid');
      btn.disabled=true; btn.textContent='SCANNING...'; bar.classList.add('on'); grid.classList.add('scanning');
      ['rCore','rGeo','rPorts','rDns','rHttp'].forEach(id=>document.getElementById(id).innerHTML='');
      document.getElementById('typebadge').style.display='none';
      document.getElementById('portmeta').textContent='';
      document.getElementById('btnCopy').disabled=true; document.getElementById('btnExport').disabled=true;
      log(`Trace: ${input}`,'i');
      try {
        const res=await fetch('/api/lookup',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({value:input})});
        if(res.status===429) throw new Error('Rate limit reached. Wait 1 minute.');
        const data=await res.json();
        if(data.error) throw new Error(data.error);
        log(`Done — ${(data.openPorts||[]).length} port(s) open · ${(data.dns.txt||[]).length} TXT record(s)`);
        last=data;
        document.getElementById('btnCopy').disabled=false; document.getElementById('btnExport').disabled=false;
        render(data);
        saveH({i:input, ip:data.ip, hostname:data.hostname, cc:data.geo?.countryCode});
        renderH();
      } catch(e) {
        log(`ERROR: ${e.message}`,'e');
        document.getElementById('rCore').innerHTML=`<div class="idle" style="color:var(--red)"><span class="idle-icon">[ ✕ ]</span><span class="idle-txt">${e.message}</span></div>`;
      } finally {
        btn.disabled=false; btn.textContent='EXECUTE'; bar.classList.remove('on'); grid.classList.remove('scanning');
      }
    }

    // ── COPY / EXPORT ─────────────────────────────────────────────────────
    document.getElementById('btnCopy').addEventListener('click', async ()=>{
      if(!last) return;
      const j=JSON.stringify(last,null,2);
      try{ await navigator.clipboard.writeText(j); log('JSON copied to clipboard.'); }
      catch{ const t=document.createElement('textarea'); t.value=j; t.style.cssText='position:fixed;opacity:0'; document.body.appendChild(t); t.select(); document.execCommand('copy'); document.body.removeChild(t); log('JSON copied (fallback).'); }
    });
    document.getElementById('btnExport').addEventListener('click', ()=>{
      if(!last) return;
      const j=JSON.stringify(last,null,2), b=new Blob([j],{type:'application/json'}), u=URL.createObjectURL(b), a=document.createElement('a');
      const n=`nexus-${(last.hostname||last.ip).replace(/[^a-z0-9.-]/gi,'_')}-${Date.now()}.json`;
      a.href=u; a.download=n; a.click(); URL.revokeObjectURL(u); log(`Exported: ${n}`);
    });

    // ── EVENTS ────────────────────────────────────────────────────────────
    document.getElementById('qbtn').addEventListener('click', run);
    document.getElementById('qi').addEventListener('keydown', e=>{ if(e.key==='Enter') run(); });
  </script>
</body>
</html>
